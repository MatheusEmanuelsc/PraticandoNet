


# üîí Autentica√ß√£o de Dois Fatores (2FA) no ASP.NET Core 8

Este tutorial explica como adicionar **autentica√ß√£o de dois fatores (2FA)** ao sistema de autentica√ß√£o descrito anteriormente, utilizando **ASP.NET Core 8**, **Identity** e **JWT**. O 2FA ser√° implementado com um aplicativo autenticador (como Google Authenticator ou Microsoft Authenticator), permitindo que os usu√°rios ativem o segundo fator e validem c√≥digos durante o login.

## üìò √çndice

1. [O que √© 2FA e Por que Usar?](#o-que-√©-2fa-e-por-que-usar)
2. [Pr√©-requisitos](#pr√©-requisitos)
3. [Configura√ß√£o do Identity para 2FA](#configura√ß√£o-do-identity-para-2fa)
4. [DTOs para 2FA](#dtos-para-2fa)
5. [Atualiza√ß√£o do Controller de Usu√°rios](#atualiza√ß√£o-do-controller-de-usu√°rios)
6. [Boas Pr√°ticas e Considera√ß√µes](#boas-pr√°ticas-e-considera√ß√µes)

## O que √© 2FA e Por que Usar?

A **autentica√ß√£o de dois fatores** adiciona uma camada extra de seguran√ßa, exigindo um segundo m√©todo de verifica√ß√£o al√©m da senha. Usaremos c√≥digos gerados por um aplicativo autenticador baseado em TOTP (*Time-based One-Time Password*).

**Benef√≠cios**:

- Prote√ß√£o contra roubo de senhas.
- Maior seguran√ßa para contas sens√≠veis.
- Integra√ß√£o nativa com o ASP.NET Core Identity.

## Pr√©-requisitos

- **Projeto Existente**: Um projeto ASP.NET Core 8 com **Identity** e **JWT**, conforme o tutorial anterior.
- **Pacotes**: J√° inclu√≠mos `Microsoft.AspNetCore.Identity.EntityFrameworkCore` e `Microsoft.AspNetCore.Authentication.JwtBearer`.
- **Aplicativo Autenticador**: Usu√°rios precisar√£o de um app como Google Authenticator ou Microsoft Authenticator.

## Configura√ß√£o do Identity para 2FA

O Identity j√° est√° configurado no tutorial anterior com suporte a tokens padr√£o:

```csharp
builder.Services.AddIdentity<ApplicationUser, IdentityRole>(options =>
{
    options.SignIn.RequireConfirmedEmail = true;
    options.Password.RequireDigit = true;
    options.Password.RequiredLength = 8;
})
.AddEntityFrameworkStores<ApplicationDbContext>()
.AddDefaultTokenProviders();
```

Para suportar 2FA, adicione configura√ß√µes espec√≠ficas no `Program.cs`:

```csharp
builder.Services.AddIdentity<ApplicationUser, IdentityRole>(options =>
{
    options.SignIn.RequireConfirmedEmail = true;
    options.Password.RequireDigit = true;
    options.Password.RequiredLength = 8;
    options.TwoFactorAuthentication.TwoFactorRequired = false; // 2FA opcional
    options.TwoFactorAuthentication.TokenLifespan = TimeSpan.FromMinutes(5); // Validade do c√≥digo
})
.AddEntityFrameworkStores<ApplicationDbContext>()
.AddDefaultTokenProviders();
```

## DTOs para 2FA

Adicione DTOs para gerenciar a ativa√ß√£o e valida√ß√£o do 2FA:

```csharp
public class EnableTwoFactorDTO
{
    [Required]
    public string Code { get; set; } = null!;
}

public class TwoFactorLoginDTO
{
    [Required]
    public string UserName { get; set; } = null!;
    [Required]
    public string Password { get; set; } = null!;
    [Required]
    public string TwoFactorCode { get; set; } = null!;
}
```

Os DTOs existentes (`RegisterDTO`, `LoginDTO`, `RespuestaAutenticacionDTO`) n√£o precisam de altera√ß√µes.

## Atualiza√ß√£o do Controller de Usu√°rios

Atualize o controller para suportar:

- **Ativar 2FA**: Gerar um QR Code para o autenticador.
- **Validar 2FA**: Confirmar o c√≥digo do autenticador.
- **Login com 2FA**: Autenticar com senha e c√≥digo 2FA.

### Controller Atualizado

```csharp
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.IdentityModel.Tokens;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;

namespace SuaApi.Controllers
{
    [ApiController]
    [Route("api/usuarios")]
    public class UsuariosController : ControllerBase
    {
        private readonly UserManager<ApplicationUser> _userManager;
        private readonly SignInManager<ApplicationUser> _signInManager;
        private readonly IConfiguration _configuration;
        private readonly RoleManager<IdentityRole> _roleManager;
        private readonly IEmailService _emailService;

        public UsuariosController(
            UserManager<ApplicationUser> userManager,
            SignInManager<ApplicationUser> signInManager,
            IConfiguration configuration,
            RoleManager<IdentityRole> roleManager,
            IEmailService emailService)
        {
            _userManager = userManager;
            _signInManager = signInManager;
            _configuration = configuration;
            _roleManager = roleManager;
            _emailService = emailService;
        }

        [HttpGet("two-factor/setup")]
        [Authorize]
        public async Task<IActionResult> GetTwoFactorSetup()
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null)
                return NotFound(new { Message = "Usu√°rio n√£o encontrado" });

            if (await _userManager.GetTwoFactorEnabledAsync(user))
                return Ok(new { Message = "2FA j√° est√° habilitado" });

            var authenticatorKey = await _userManager.GetAuthenticatorKeyAsync(user);
            if (string.IsNullOrEmpty(authenticatorKey))
            {
                await _userManager.ResetAuthenticatorKeyAsync(user);
                authenticatorKey = await _userManager.GetAuthenticatorKeyAsync(user);
            }

            var email = user.Email;
            var issuer = _configuration["Jwt:Issuer"];
            var qrCodeUri = $"otpauth://totp/{issuer}:{email}?secret={authenticatorKey}&issuer={issuer}";

            return Ok(new { AuthenticatorKey = authenticatorKey, QrCodeUri = qrCodeUri });
        }

        [HttpPost("two-factor/enable")]
        [Authorize]
        public async Task<IActionResult> EnableTwoFactor(EnableTwoFactorDTO dto)
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null)
                return NotFound(new { Message = "Usu√°rio n√£o encontrado" });

            var isValidCode = await _userManager.VerifyTwoFactorTokenAsync(
                user, _userManager.Options.Tokens.AuthenticatorTokenProvider, dto.Code);

            if (!isValidCode)
                return BadRequest(new { Message = "C√≥digo 2FA inv√°lido" });

            var result = await _userManager.SetTwoFactorEnabledAsync(user, true);
            if (!result.Succeeded)
                return BadRequest(result.Errors);

            var recoveryCodes = await _userManager.GenerateNewTwoFactorRecoveryCodesAsync(user, 10);
            return Ok(new { Message = "2FA habilitado com sucesso", RecoveryCodes = recoveryCodes });
        }

        [HttpPost("two-factor/login")]
        [AllowAnonymous]
        public async Task<IActionResult> TwoFactorLogin(TwoFactorLoginDTO dto)
        {
            var user = await _userManager.FindByNameAsync(dto.UserName);
            if (user == null || !await _userManager.CheckPasswordAsync(user, dto.Password))
                return Unauthorized(new { Message = "Credenciais inv√°lidas" });

            if (!await _userManager.GetTwoFactorEnabledAsync(user))
                return BadRequest(new { Message = "2FA n√£o est√° habilitado para este usu√°rio" });

            var isValidCode = await _userManager.VerifyTwoFactorTokenAsync(
                user, _userManager.Options.Tokens.AuthenticatorTokenProvider, dto.TwoFactorCode);

            if (!isValidCode)
                return Unauthorized(new { Message = "C√≥digo 2FA inv√°lido" });

            var token = await GenerateJwtToken(user);
            return Ok(token);
        }

        [HttpPost("login")]
        [AllowAnonymous]
        public async Task<IActionResult> Login(LoginDTO dto)
        {
            var user = await _userManager.FindByNameAsync(dto.UserName);
            if (user == null || !await _userManager.CheckPasswordAsync(user, dto.Password))
                return Unauthorized(new { Message = "Credenciais inv√°lidas" });

            if (await _userManager.GetTwoFactorEnabledAsync(user))
                return Ok(new { Message = "2FA necess√°rio", RequiresTwoFactor = true });

            var token = await GenerateJwtToken(user);
            return Ok(token);
        }

        private async Task<RespuestaAutenticacionDTO> GenerateJwtToken(ApplicationUser user)
        {
            var claims = new List<Claim>
            {
                new Claim(JwtRegisteredClaimNames.Sub, user.UserName),
                new Claim(JwtRegisteredClaimNames.Email, user.Email),
                new Claim("NomeCompleto", user.NomeCompleto)
            };

            var userClaims = await _userManager.GetClaimsAsync(user);
            claims.AddRange(userClaims);

            var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(_configuration["Jwt:Key"]));
            var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

            var token = new JwtSecurityToken(
                issuer: _configuration["Jwt:Issuer"],
                audience: _configuration["Jwt:Audience"],
                claims: claims,
                expires: DateTime.UtcNow.AddMinutes(30),
                signingCredentials: creds);

            var refreshToken = Guid.NewGuid().ToString();
            // TODO: Salvar refreshToken no banco de dados

            return new RespuestaAutenticacionDTO
            {
                Token = new JwtSecurityTokenHandler().WriteToken(token),
                RefreshToken = refreshToken,
                Expiracion = token.ValidTo
            };
        }

        // Outros m√©todos (registro, esqueci-senha, etc.) conforme tutorial anterior
    }
}
```

## Boas Pr√°ticas e Considera√ß√µes

- **QR Code no Frontend**: Use uma biblioteca como `qrcode.js` para exibir o `QrCodeUri` retornado pelo endpoint `two-factor/setup`.
- **C√≥digos de Recupera√ß√£o**: Forne√ßa e armazene c√≥digos de recupera√ß√£o com seguran√ßa, permitindo login em caso de perda do autenticador.
- **2FA Opcional vs. Obrigat√≥rio**: O 2FA √© opcional neste exemplo. Para torn√°-lo obrigat√≥rio, configure `TwoFactorRequired = true` no `Program.cs`.
- **Outros Provedores**: Considere 2FA via e-mail ou SMS, usando o `_emailService` do tutorial de e-mails.
- **Seguran√ßa**: Proteja endpoints sens√≠veis com autentica√ß√£o forte e valide todas as entradas.
- **Integra√ß√£o com Google**: O login com Google (tutorial anterior) pode pular o 2FA, j√° que √© uma autentica√ß√£o forte.
- **Testes**: Teste o fluxo com um aplicativo autenticador real em ambiente local.

---

Este tutorial adiciona **autentica√ß√£o de dois fatores** ao sistema original, permitindo que usu√°rios habilitem 2FA com um aplicativo autenticador e fa√ßam login com um segundo fator. Ele √© compat√≠vel com os tutoriais anteriores (e-mails e login com Google).

