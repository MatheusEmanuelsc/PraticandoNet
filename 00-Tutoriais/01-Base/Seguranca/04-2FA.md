

# 游 Autentica칞칚o de Dois Fatores (2FA) no ASP.NET Core 8

Este guia detalha como implementar **autentica칞칚o de dois fatores (2FA)** em uma **Web API ASP.NET Core 8** usando **TOTP (Time-based One-Time Password)** com o **ASP.NET Core Identity**. Usu치rios podem ativar o 2FA via apps como Google Authenticator, validar c칩digos no login, e gerenciar configura칞칫es. O c칩digo 칠 comentado, integrado com JWT (dos resumos anteriores), e formatado para renderiza칞칚o no GitHub.

## 游닂 칈ndice

1. Pacotes Necess치rios
2. Configura칞칚o do Identity
3. Configura칞칚o do JWT
4. Modelos e DTOs
5. TwoFactorController
6. Ajustes no AuthController
7. Boas Pr치ticas e Seguran칞a
8. Tabela de Endpoints

---

## 1. 游닍 Pacotes Necess치rios

Adicione os pacotes via NuGet para Identity, autentica칞칚o JWT e Entity Framework:

```bash
dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore
dotnet add package Microsoft.AspNetCore.Authentication.JwtBearer
dotnet add package Microsoft.EntityFrameworkCore.SqlServer
```

**Explica칞칚o**:  
- `Microsoft.AspNetCore.Identity.EntityFrameworkCore`: Gerencia usu치rios e 2FA.  
- `Microsoft.AspNetCore.Authentication.JwtBearer`: Valida JWTs no login com 2FA.  
- `Microsoft.EntityFrameworkCore.SqlServer`: Persiste dados do Identity.  
Nenhum pacote extra 칠 necess치rio para TOTP, pois o Identity j치 suporta 2FA nativamente.

---

## 2. 丘뙖잺 Configura칞칚o do Identity

No `Program.cs`, configure o Identity para suportar 2FA:

```csharp
builder.Services.AddIdentity<ApplicationUser, IdentityRole>(options =>
{
    options.Password.RequireDigit = true; // Senha deve conter d칤gito
    options.Password.RequiredLength = 8; // M칤nimo de 8 caracteres
    options.TwoFactorAuthentication.Enabled = true; // Habilita 2FA
    options.TwoFactorAuthentication.TokenLifespan = TimeSpan.FromMinutes(5); // C칩digo TOTP v치lido por 5 minutos
})
.AddEntityFrameworkStores<ApplicationDbContext>() // Usa EF com contexto
.AddDefaultTokenProviders(); // Provedores para tokens TOTP e outros
```

**Explica칞칚o**:  
- `TwoFactorAuthentication.Enabled = true`: Ativa o suporte a 2FA.  
- `TokenLifespan`: Define o tempo de validade dos c칩digos TOTP.  
- `AddDefaultTokenProviders()`: Inclui o provedor TOTP para gerar c칩digos.

---

## 3. 游댐 Configura칞칚o do JWT

### `appsettings.json`

Defina as configura칞칫es do JWT (compat칤vel com resumos anteriores):

```json
{
  "Jwt": {
    "Key": "sua-chave-secreta-de-32-caracteres-ou-mais", // Chave para JWT
    "Issuer": "MinhaApi", // Emissor
    "Audience": "ClientesDaMinhaApi" // Audi칡ncia
  }
}
```

### `Program.cs`

Configure a autentica칞칚o JWT:

```csharp
var configuration = builder.Configuration;

builder.Services.AddAuthentication(options =>
{
    options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme; // JWT como padr칚o
    options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
})
.AddJwtBearer(options =>
{
    options.TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuer = true, // Valida emissor
        ValidIssuer = configuration["Jwt:Issuer"],
        ValidateAudience = true, // Valida audi칡ncia
        ValidAudience = configuration["Jwt:Audience"],
        ValidateIssuerSigningKey = true, // Valida chave
        IssuerSigningKey = new SymmetricSecurityKey(
            Encoding.UTF8.GetBytes(configuration["Jwt:Key"])
        ),
        ValidateLifetime = true, // Verifica expira칞칚o
        ClockSkew = TimeSpan.Zero // Sem toler칙ncia
    };
});

builder.Services.AddAuthorization(); // Habilita autoriza칞칚o
```

**Explica칞칚o**:  
Configura o JWT para proteger endpoints e gerar tokens ap칩s valida칞칚o do 2FA.

---

## 4. 游녻 Modelos e DTOs

### Modelo: `ApplicationUser`

```csharp
public class ApplicationUser : IdentityUser
{
    public string NomeCompleto { get; set; } = string.Empty; // Nome completo
}
```

**Explica칞칚o**:  
Herda de `IdentityUser`, que j치 inclui propriedades para 2FA (ex.: `TwoFactorEnabled`).

### DTOs

#### `EnableTwoFactorDTO`

```csharp
public class EnableTwoFactorDTO
{
    [Required]
    public string SharedKey { get; set; } = null!; // Chave para configurar app autenticador
    [Required, StringLength(6, MinimumLength = 6)]
    public string Code { get; set; } = null!; // C칩digo TOTP para valida칞칚o
}
```

**Explica칞칚o**:  
Usado para ativar o 2FA, enviando a chave e um c칩digo inicial.

#### `TwoFactorLoginDTO`

```csharp
public class TwoFactorLoginDTO
{
    [Required]
    public string UserName { get; set; } = null!; // Nome de usu치rio
    [Required]
    public string Password { get; set; } = null!; // Senha
    [Required, StringLength(6, MinimumLength = 6)]
    public string TwoFactorCode { get; set; } = null!; // C칩digo TOTP
}
```

**Explica칞칚o**:  
Recebe credenciais e c칩digo TOTP para login com 2FA.

#### `RespuestaAutenticacionDTO`

```csharp
public class RespuestaAutenticacionDTO
{
    public string Token { get; set; } = null!; // JWT gerado
    public DateTime Expiracion { get; set; } // Expira칞칚o
}
```

**Explica칞칚o**:  
Retorna o JWT ap칩s login bem-sucedido.

---

## 5. 游꿡 TwoFactorController

Crie um controller dedicado para gerenciar o 2FA:

```csharp
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using System.Threading.Tasks;

// Controlador para gerenciamento de 2FA
[ApiController]
[Route("api/twofactor")]
public class TwoFactorController : ControllerBase
{
    private readonly UserManager<ApplicationUser> _userManager; // Gerencia usu치rios

    public TwoFactorController(UserManager<ApplicationUser> userManager)
    {
        _userManager = userManager;
    }

    // Gera chave para configurar 2FA
    [HttpGet("setup")]
    [Authorize] // Requer autentica칞칚o
    public async Task<IActionResult> SetupTwoFactor()
    {
        // Obt칠m usu치rio autenticado
        var user = await _userManager.GetUserAsync(User);
        if (user == null)
            return NotFound(new { Message = "Usu치rio n칚o encontrado." });

        // Gera chave compartilhada para app autenticador
        var sharedKey = await _userManager.GetTwoFactorSharedKeyAsync(user);
        if (string.IsNullOrEmpty(sharedKey))
        {
            await _userManager.ResetTwoFactorSharedKeyAsync(user);
            sharedKey = await _userManager.GetTwoFactorSharedKeyAsync(user);
        }

        // Formata chave para QR code (ex.: otpauth://totp/)
        var issuer = "MinhaApi";
        var authenticatorUri = $"otpauth://totp/{issuer}:{user.Email}?secret={sharedKey}&issuer={issuer}";

        return Ok(new { SharedKey = sharedKey, AuthenticatorUri = authenticatorUri });
    }

    // Ativa o 2FA para o usu치rio
    [HttpPost("enable")]
    [Authorize]
    public async Task<IActionResult> EnableTwoFactor(EnableTwoFactorDTO dto)
    {
        // Obt칠m usu치rio
        var user = await _userManager.GetUserAsync(User);
        if (user == null)
            return NotFound(new { Message = "Usu치rio n칚o encontrado." });

        // Valida c칩digo TOTP
        var isValidCode = await _userManager.VerifyTwoFactorTokenAsync(
            user,
            _userManager.Options.Tokens.AuthenticatorTokenProvider,
            dto.Code
        );
        if (!isValidCode)
            return BadRequest(new { Message = "C칩digo TOTP inv치lido." });

        // Ativa 2FA
        await _userManager.SetTwoFactorEnabledAsync(user, true);
        return Ok(new { Message = "2FA ativado com sucesso." });
    }

    // Desativa o 2FA
    [HttpPost("disable")]
    [Authorize]
    public async Task<IActionResult> DisableTwoFactor()
    {
        // Obt칠m usu치rio
        var user = await _userManager.GetUserAsync(User);
        if (user == null)
            return NotFound(new { Message = "Usu치rio n칚o encontrado." });

        // Desativa 2FA
        await _userManager.SetTwoFactorEnabledAsync(user, false);
        await _userManager.ResetTwoFactorSharedKeyAsync(user);
        return Ok(new { Message = "2FA desativado com sucesso." });
    }
}
```

**Explica칞칚o**:  
- `SetupTwoFactor`: Gera uma chave TOTP e URI para QR code (escane치vel por apps como Google Authenticator).  
- `EnableTwoFactor`: Valida o c칩digo inicial e ativa o 2FA.  
- `DisableTwoFactor`: Desativa o 2FA e reseta a chave.

---

## 6. 游댃 Ajustes no AuthController

Adapte o `AuthController` (dos resumos anteriores) para suportar login com 2FA:

```csharp
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.IdentityModel.Tokens;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;

// Controlador para autentica칞칚o com 2FA
[ApiController]
[Route("api/auth")]
public class AuthController : ControllerBase
{
    private readonly UserManager<ApplicationUser> _userManager; // Gerencia usu치rios
    private readonly SignInManager<ApplicationUser> _signInManager; // Gerencia login
    private readonly IConfiguration _configuration; // Configura칞칫es

    public AuthController(
        UserManager<ApplicationUser> userManager,
        SignInManager<ApplicationUser> signInManager,
        IConfiguration configuration)
    {
        _userManager = userManager;
        _signInManager = signInManager;
        _configuration = configuration;
    }

    // Faz login com 2FA
    [HttpPost("login-2fa")]
    [AllowAnonymous]
    public async Task<IActionResult> LoginWithTwoFactor(TwoFactorLoginDTO dto)
    {
        // Busca usu치rio
        var user = await _userManager.FindByNameAsync(dto.UserName);
        if (user == null)
            return Unauthorized(new { Message = "Credenciais inv치lidas." });

        // Verifica senha
        var passwordSignIn = await _signInManager.CheckPasswordSignInAsync(user, dto.Password, false);
        if (!passwordSignIn.Succeeded)
            return Unauthorized(new { Message = "Credenciais inv치lidas." });

        // Verifica se 2FA est치 ativado
        if (!await _userManager.GetTwoFactorEnabledAsync(user))
            return BadRequest(new { Message = "2FA n칚o est치 ativado." });

        // Valida c칩digo TOTP
        var isValidCode = await _userManager.VerifyTwoFactorTokenAsync(
            user,
            _userManager.Options.Tokens.AuthenticatorTokenProvider,
            dto.TwoFactorCode
        );
        if (!isValidCode)
            return Unauthorized(new { Message = "C칩digo 2FA inv치lido." });

        // Gera JWT
        var token = await GenerateJwtToken(user);
        return Ok(token);
    }

    // Gera JWT
    private async Task<RespuestaAutenticacionDTO> GenerateJwtToken(ApplicationUser user)
    {
        // Define claims
        var claims = new List<Claim>
        {
            new Claim(JwtRegisteredClaimNames.Sub, user.UserName),
            new Claim(JwtRegisteredClaimNames.Email, user.Email),
            new Claim(JwtRegisteredClaimNames.Jti, Guid.NewGuid().ToString()),
            new Claim("NomeCompleto", user.NomeCompleto),
            new Claim("Id", user.Id)
        };

        // Adiciona roles
        var userRoles = await _userManager.GetRolesAsync(user);
        claims.AddRange(userRoles.Select(role => new Claim(ClaimTypes.Role, role)));

        // Adiciona claims personalizadas
        var userClaims = await _userManager.GetClaimsAsync(user);
        claims.AddRange(userClaims);

        // Configura chave
        var key = new SymmetricSecurityKey(
            Encoding.UTF8.GetBytes(_configuration["Jwt:Key"])
        );
        var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);
        var expiry = DateTime.UtcNow.AddMinutes(30);

        // Cria JWT
        var token = new JwtSecurityToken(
            issuer: _configuration["Jwt:Issuer"],
            audience: _configuration["Jwt:Audience"],
            claims: claims,
            expires: expiry,
            signingCredentials: creds
        );

        // Retorna DTO
        return new RespuestaAutenticacionDTO
        {
            Token = new JwtSecurityTokenHandler().WriteToken(token),
            Expiracion = expiry
        };
    }
}
```

**Explica칞칚o**:  
- `LoginWithTwoFactor`: Valida nome de usu치rio, senha, e c칩digo TOTP, gerando um JWT se tudo estiver correto.  
- `GenerateJwtToken`: Reutilizado dos resumos anteriores, cria um JWT com claims do usu치rio.

---

## 7. 游늷 Boas Pr치ticas e Seguran칞a

- **Valida칞칚o**: Use Data Annotations nos DTOs para garantir entradas v치lidas.  
- **Seguran칞a de Chaves**: Armazene a chave JWT em vari치veis de ambiente.  
- **C칩digos TOTP**: O Identity usa algoritmos seguros (HMAC-SHA1) para TOTP, compat칤veis com RFC 6238.  
- **Rate Limiting**: Limite tentativas de login para evitar ataques de for칞a bruta.  
- **Backup**: Ofere칞a c칩digos de recupera칞칚o (n칚o implementado aqui, mas pode ser adicionado com `_userManager.GenerateRecoveryCodesAsync`).  
- **HTTPS**: Force HTTPS para proteger c칩digos TOTP e JWTs.  
- **Alternativas**: Considere 2FA via e-mail ou SMS (ex.: use o `EmailService` do resumo de 16/04/2025):
  ```csharp
  var code = await _userManager.GenerateTwoFactorTokenAsync(user, "Email");
  await _emailService.SendEmailAsync(user.Email, "C칩digo 2FA", $"Seu c칩digo: {code}");
  ```
- **Logging**: Registre tentativas de login com 2FA para auditoria.  
- **Testes**: Crie testes para validar gera칞칚o e verifica칞칚o de c칩digos TOTP.

---

## 8. 游늶 Tabela de Endpoints

| M칠todo | Endpoint                    | Descri칞칚o                              | Autentica칞칚o |
|--------|-----------------------------|----------------------------------------|--------------|
| GET    | `/api/twofactor/setup`      | Gera chave para configurar 2FA         | Requer JWT   |
| POST   | `/api/twofactor/enable`     | Ativa 2FA com c칩digo TOTP              | Requer JWT   |
| POST   | `/api/twofactor/disable`    | Desativa 2FA                           | Requer JWT   |
| POST   | `/api/auth/login-2fa`       | Faz login com senha e c칩digo TOTP      | An칪nimo      |



---

### Integra칞칚o com Resumos Anteriores

Este resumo 칠 compat칤vel com seus projetos anteriores:
- **Autentica칞칚o (14/04/2025)**: Adicione o `TwoFactorController` e o endpoint `login-2fa` ao `AuthController` existente. Reutilize o `ApplicationUser`, configura칞칫es JWT, e `ApplicationDbContext`.
- **Envio de E-mails (16/04/2025)**: Se quiser 2FA por e-mail, use o `EmailService` para enviar c칩digos TOTP (mostrei uma sugest칚o acima).
- **Login com Google (16/04/2025)**: Para exigir 2FA ap칩s login com Google, adicione uma etapa de valida칞칚o TOTP no `ExternalLoginCallback`, verificando `TwoFactorEnabled`.

Para integrar:
1. Inclua o `SignInManager` no `AuthController` (j치 adicionado acima).
2. Adicione o `TwoFactorController` ao projeto.
3. Reintroduza `options.TwoFactorAuthentication.Enabled = true` no Identity.
4. Combine com endpoints existentes (ex.: `login`, `refresh-token`).

