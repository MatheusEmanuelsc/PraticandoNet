

# üîí Autentica√ß√£o de Dois Fatores (2FA) no ASP.NET Core 8

Este guia detalha como implementar **autentica√ß√£o de dois fatores (2FA)** em uma **Web API ASP.NET Core 8** usando **TOTP (Time-based One-Time Password)** com o **ASP.NET Core Identity**. Usu√°rios podem ativar o 2FA via apps como Google Authenticator, validar c√≥digos no login, e gerenciar configura√ß√µes. O c√≥digo √© comentado, integrado com JWT (dos resumos anteriores), e formatado para renderiza√ß√£o no GitHub.

## üìò √çndice

1. Pacotes Necess√°rios
2. Configura√ß√£o do Identity
3. Configura√ß√£o do JWT
4. Modelos e DTOs
5. TwoFactorController
6. Ajustes no AuthController
7. Boas Pr√°ticas e Seguran√ßa
8. Tabela de Endpoints

---

## 1. üì¶ Pacotes Necess√°rios

Adicione os pacotes via NuGet para Identity, autentica√ß√£o JWT e Entity Framework:

```bash
dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore
dotnet add package Microsoft.AspNetCore.Authentication.JwtBearer
dotnet add package Microsoft.EntityFrameworkCore.SqlServer
```

**Explica√ß√£o**:  
- `Microsoft.AspNetCore.Identity.EntityFrameworkCore`: Gerencia usu√°rios e 2FA.  
- `Microsoft.AspNetCore.Authentication.JwtBearer`: Valida JWTs no login com 2FA.  
- `Microsoft.EntityFrameworkCore.SqlServer`: Persiste dados do Identity.  
Nenhum pacote extra √© necess√°rio para TOTP, pois o Identity j√° suporta 2FA nativamente.

---

## 2. ‚öôÔ∏è Configura√ß√£o do Identity

No `Program.cs`, configure o Identity para suportar 2FA:

```csharp
builder.Services.AddIdentity<ApplicationUser, IdentityRole>(options =>
{
    options.Password.RequireDigit = true; // Senha deve conter d√≠gito
    options.Password.RequiredLength = 8; // M√≠nimo de 8 caracteres
    options.TwoFactorAuthentication.Enabled = true; // Habilita 2FA
    options.TwoFactorAuthentication.TokenLifespan = TimeSpan.FromMinutes(5); // C√≥digo TOTP v√°lido por 5 minutos
})
.AddEntityFrameworkStores<ApplicationDbContext>() // Usa EF com contexto
.AddDefaultTokenProviders(); // Provedores para tokens TOTP e outros
```

**Explica√ß√£o**:  
- `TwoFactorAuthentication.Enabled = true`: Ativa o suporte a 2FA.  
- `TokenLifespan`: Define o tempo de validade dos c√≥digos TOTP.  
- `AddDefaultTokenProviders()`: Inclui o provedor TOTP para gerar c√≥digos.

---

## 3. üîë Configura√ß√£o do JWT

### `appsettings.json`

Defina as configura√ß√µes do JWT (compat√≠vel com resumos anteriores):

```json
{
  "Jwt": {
    "Key": "sua-chave-secreta-de-32-caracteres-ou-mais", // Chave para JWT
    "Issuer": "MinhaApi", // Emissor
    "Audience": "ClientesDaMinhaApi" // Audi√™ncia
  }
}
```

### `Program.cs`

Configure a autentica√ß√£o JWT:

```csharp
var configuration = builder.Configuration;

builder.Services.AddAuthentication(options =>
{
    options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme; // JWT como padr√£o
    options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
})
.AddJwtBearer(options =>
{
    options.TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuer = true, // Valida emissor
        ValidIssuer = configuration["Jwt:Issuer"],
        ValidateAudience = true, // Valida audi√™ncia
        ValidAudience = configuration["Jwt:Audience"],
        ValidateIssuerSigningKey = true, // Valida chave
        IssuerSigningKey = new SymmetricSecurityKey(
            Encoding.UTF8.GetBytes(configuration["Jwt:Key"])
        ),
        ValidateLifetime = true, // Verifica expira√ß√£o
        ClockSkew = TimeSpan.Zero // Sem toler√¢ncia
    };
});

builder.Services.AddAuthorization(); // Habilita autoriza√ß√£o
```

**Explica√ß√£o**:  
Configura o JWT para proteger endpoints e gerar tokens ap√≥s valida√ß√£o do 2FA.

---

## 4. üë§ Modelos e DTOs

### Modelo: `ApplicationUser`

```csharp
public class ApplicationUser : IdentityUser
{
    public string NomeCompleto { get; set; } = string.Empty; // Nome completo
}
```

**Explica√ß√£o**:  
Herda de `IdentityUser`, que j√° inclui propriedades para 2FA (ex.: `TwoFactorEnabled`).

### DTOs

#### `EnableTwoFactorDTO`

```csharp
public class EnableTwoFactorDTO
{
    [Required]
    public string SharedKey { get; set; } = null!; // Chave para configurar app autenticador
    [Required, StringLength(6, MinimumLength = 6)]
    public string Code { get; set; } = null!; // C√≥digo TOTP para valida√ß√£o
}
```

**Explica√ß√£o**:  
Usado para ativar o 2FA, enviando a chave e um c√≥digo inicial.

#### `TwoFactorLoginDTO`

```csharp
public class TwoFactorLoginDTO
{
    [Required]
    public string UserName { get; set; } = null!; // Nome de usu√°rio
    [Required]
    public string Password { get; set; } = null!; // Senha
    [Required, StringLength(6, MinimumLength = 6)]
    public string TwoFactorCode { get; set; } = null!; // C√≥digo TOTP
}
```

**Explica√ß√£o**:  
Recebe credenciais e c√≥digo TOTP para login com 2FA.

#### `RespuestaAutenticacionDTO`

```csharp
public class RespuestaAutenticacionDTO
{
    public string Token { get; set; } = null!; // JWT gerado
    public DateTime Expiracion { get; set; } // Expira√ß√£o
}
```

**Explica√ß√£o**:  
Retorna o JWT ap√≥s login bem-sucedido.

---

## 5. üéÆ TwoFactorController

Crie um controller dedicado para gerenciar o 2FA:

```csharp
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using System.Threading.Tasks;

// Controlador para gerenciamento de 2FA
[ApiController]
[Route("api/twofactor")]
public class TwoFactorController : ControllerBase
{
    private readonly UserManager<ApplicationUser> _userManager; // Gerencia usu√°rios

    public TwoFactorController(UserManager<ApplicationUser> userManager)
    {
        _userManager = userManager;
    }

    // Gera chave para configurar 2FA
    [HttpGet("setup")]
    [Authorize] // Requer autentica√ß√£o
    public async Task<IActionResult> SetupTwoFactor()
    {
        // Obt√©m usu√°rio autenticado
        var user = await _userManager.GetUserAsync(User);
        if (user == null)
            return NotFound(new { Message = "Usu√°rio n√£o encontrado." });

        // Gera chave compartilhada para app autenticador
        var sharedKey = await _userManager.GetTwoFactorSharedKeyAsync(user);
        if (string.IsNullOrEmpty(sharedKey))
        {
            await _userManager.ResetTwoFactorSharedKeyAsync(user);
            sharedKey = await _userManager.GetTwoFactorSharedKeyAsync(user);
        }

        // Formata chave para QR code (ex.: otpauth://totp/)
        var issuer = "MinhaApi";
        var authenticatorUri = $"otpauth://totp/{issuer}:{user.Email}?secret={sharedKey}&issuer={issuer}";

        return Ok(new { SharedKey = sharedKey, AuthenticatorUri = authenticatorUri });
    }

    // Ativa o 2FA para o usu√°rio
    [HttpPost("enable")]
    [Authorize]
    public async Task<IActionResult> EnableTwoFactor(EnableTwoFactorDTO dto)
    {
        // Obt√©m usu√°rio
        var user = await _userManager.GetUserAsync(User);
        if (user == null)
            return NotFound(new { Message = "Usu√°rio n√£o encontrado." });

        // Valida c√≥digo TOTP
        var isValidCode = await _userManager.VerifyTwoFactorTokenAsync(
            user,
            _userManager.Options.Tokens.AuthenticatorTokenProvider,
            dto.Code
        );
        if (!isValidCode)
            return BadRequest(new { Message = "C√≥digo TOTP inv√°lido." });

        // Ativa 2FA
        await _userManager.SetTwoFactorEnabledAsync(user, true);
        return Ok(new { Message = "2FA ativado com sucesso." });
    }

    // Desativa o 2FA
    [HttpPost("disable")]
    [Authorize]
    public async Task<IActionResult> DisableTwoFactor()
    {
        // Obt√©m usu√°rio
        var user = await _userManager.GetUserAsync(User);
        if (user == null)
            return NotFound(new { Message = "Usu√°rio n√£o encontrado." });

        // Desativa 2FA
        await _userManager.SetTwoFactorEnabledAsync(user, false);
        await _userManager.ResetTwoFactorSharedKeyAsync(user);
        return Ok(new { Message = "2FA desativado com sucesso." });
    }
}
```

**Explica√ß√£o**:  
- `SetupTwoFactor`: Gera uma chave TOTP e URI para QR code (escane√°vel por apps como Google Authenticator).  
- `EnableTwoFactor`: Valida o c√≥digo inicial e ativa o 2FA.  
- `DisableTwoFactor`: Desativa o 2FA e reseta a chave.

---

## 6. üîÑ Ajustes no AuthController

Adapte o `AuthController` (dos resumos anteriores) para suportar login com 2FA:

```csharp
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.IdentityModel.Tokens;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;

// Controlador para autentica√ß√£o com 2FA
[ApiController]
[Route("api/auth")]
public class AuthController : ControllerBase
{
    private readonly UserManager<ApplicationUser> _userManager; // Gerencia usu√°rios
    private readonly SignInManager<ApplicationUser> _signInManager; // Gerencia login
    private readonly IConfiguration _configuration; // Configura√ß√µes

    public AuthController(
        UserManager<ApplicationUser> userManager,
        SignInManager<ApplicationUser> signInManager,
        IConfiguration configuration)
    {
        _userManager = userManager;
        _signInManager = signInManager;
        _configuration = configuration;
    }

    // Faz login com 2FA
    [HttpPost("login-2fa")]
    [AllowAnonymous]
    public async Task<IActionResult> LoginWithTwoFactor(TwoFactorLoginDTO dto)
    {
        // Busca usu√°rio
        var user = await _userManager.FindByNameAsync(dto.UserName);
        if (user == null)
            return Unauthorized(new { Message = "Credenciais inv√°lidas." });

        // Verifica senha
        var passwordSignIn = await _signInManager.CheckPasswordSignInAsync(user, dto.Password, false);
        if (!passwordSignIn.Succeeded)
            return Unauthorized(new { Message = "Credenciais inv√°lidas." });

        // Verifica se 2FA est√° ativado
        if (!await _userManager.GetTwoFactorEnabledAsync(user))
            return BadRequest(new { Message = "2FA n√£o est√° ativado." });

        // Valida c√≥digo TOTP
        var isValidCode = await _userManager.VerifyTwoFactorTokenAsync(
            user,
            _userManager.Options.Tokens.AuthenticatorTokenProvider,
            dto.TwoFactorCode
        );
        if (!isValidCode)
            return Unauthorized(new { Message = "C√≥digo 2FA inv√°lido." });

        // Gera JWT
        var token = await GenerateJwtToken(user);
        return Ok(token);
    }

    // Gera JWT
    private async Task<RespuestaAutenticacionDTO> GenerateJwtToken(ApplicationUser user)
    {
        // Define claims
        var claims = new List<Claim>
        {
            new Claim(JwtRegisteredClaimNames.Sub, user.UserName),
            new Claim(JwtRegisteredClaimNames.Email, user.Email),
            new Claim(JwtRegisteredClaimNames.Jti, Guid.NewGuid().ToString()),
            new Claim("NomeCompleto", user.NomeCompleto),
            new Claim("Id", user.Id)
        };

        // Adiciona roles
        var userRoles = await _userManager.GetRolesAsync(user);
        claims.AddRange(userRoles.Select(role => new Claim(ClaimTypes.Role, role)));

        // Adiciona claims personalizadas
        var userClaims = await _userManager.GetClaimsAsync(user);
        claims.AddRange(userClaims);

        // Configura chave
        var key = new SymmetricSecurityKey(
            Encoding.UTF8.GetBytes(_configuration["Jwt:Key"])
        );
        var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);
        var expiry = DateTime.UtcNow.AddMinutes(30);

        // Cria JWT
        var token = new JwtSecurityToken(
            issuer: _configuration["Jwt:Issuer"],
            audience: _configuration["Jwt:Audience"],
            claims: claims,
            expires: expiry,
            signingCredentials: creds
        );

        // Retorna DTO
        return new RespuestaAutenticacionDTO
        {
            Token = new JwtSecurityTokenHandler().WriteToken(token),
            Expiracion = expiry
        };
    }
}
```

**Explica√ß√£o**:  
- `LoginWithTwoFactor`: Valida nome de usu√°rio, senha, e c√≥digo TOTP, gerando um JWT se tudo estiver correto.  
- `GenerateJwtToken`: Reutilizado dos resumos anteriores, cria um JWT com claims do usu√°rio.

---

## 7. üìå Boas Pr√°ticas e Seguran√ßa

- **Valida√ß√£o**: Use Data Annotations nos DTOs para garantir entradas v√°lidas.  
- **Seguran√ßa de Chaves**: Armazene a chave JWT em vari√°veis de ambiente.  
- **C√≥digos TOTP**: O Identity usa algoritmos seguros (HMAC-SHA1) para TOTP, compat√≠veis com RFC 6238.  
- **Rate Limiting**: Limite tentativas de login para evitar ataques de for√ßa bruta.  
- **Backup**: Ofere√ßa c√≥digos de recupera√ß√£o (n√£o implementado aqui, mas pode ser adicionado com `_userManager.GenerateRecoveryCodesAsync`).  
- **HTTPS**: Force HTTPS para proteger c√≥digos TOTP e JWTs.  
- **Alternativas**: Considere 2FA via e-mail ou SMS (ex.: use o `EmailService` do resumo de 16/04/2025):
  ```csharp
  var code = await _userManager.GenerateTwoFactorTokenAsync(user, "Email");
  await _emailService.SendEmailAsync(user.Email, "C√≥digo 2FA", $"Seu c√≥digo: {code}");
  ```
- **Logging**: Registre tentativas de login com 2FA para auditoria.  
- **Testes**: Crie testes para validar gera√ß√£o e verifica√ß√£o de c√≥digos TOTP.

---

## 8. üìã Tabela de Endpoints

| M√©todo | Endpoint                    | Descri√ß√£o                              | Autentica√ß√£o |
|--------|-----------------------------|----------------------------------------|--------------|
| GET    | `/api/twofactor/setup`      | Gera chave para configurar 2FA         | Requer JWT   |
| POST   | `/api/twofactor/enable`     | Ativa 2FA com c√≥digo TOTP              | Requer JWT   |
| POST   | `/api/twofactor/disable`    | Desativa 2FA                           | Requer JWT   |
| POST   | `/api/auth/login-2fa`       | Faz login com senha e c√≥digo TOTP      | An√¥nimo      |



---

### Integra√ß√£o com Resumos Anteriores

Este resumo √© compat√≠vel com seus projetos anteriores:
- **Autentica√ß√£o (14/04/2025)**: Adicione o `TwoFactorController` e o endpoint `login-2fa` ao `AuthController` existente. Reutilize o `ApplicationUser`, configura√ß√µes JWT, e `ApplicationDbContext`.
- **Envio de E-mails (16/04/2025)**: Se quiser 2FA por e-mail, use o `EmailService` para enviar c√≥digos TOTP (mostrei uma sugest√£o acima).
- **Login com Google (16/04/2025)**: Para exigir 2FA ap√≥s login com Google, adicione uma etapa de valida√ß√£o TOTP no `ExternalLoginCallback`, verificando `TwoFactorEnabled`.

Para integrar:
1. Inclua o `SignInManager` no `AuthController` (j√° adicionado acima).
2. Adicione o `TwoFactorController` ao projeto.
3. Reintroduza `options.TwoFactorAuthentication.Enabled = true` no Identity.
4. Combine com endpoints existentes (ex.: `login`, `refresh-token`).

